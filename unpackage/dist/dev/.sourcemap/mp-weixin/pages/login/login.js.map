{"version":3,"file":"login.js","sources":["pages/login/login.vue","D:/浏览器下载/HBuilderX.4.66.2025051912/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbG9naW4vbG9naW4udnVl"],"sourcesContent":["<template>\n    <view style=\"height:100vh;background: #fff;\">\n        <view class=\"img-a\">\n            <view class=\"t-b\">\n                您好，\n                <br />\n                欢迎使用狮山云瞳小程序\n                <view class=\"sub-title\">病害检测专用版</view>\n            </view>\n        </view>\n        <view class=\"login-view\" style=\"\">\n            <view class=\"t-login\">\n                <form class=\"cl\">\n                    <view class=\"t-a\">\n                        <text class=\"txt\">用户名</text>\n                        <input type=\"text\" name=\"username\" placeholder=\"请输入您的用户名\" maxlength=\"99\" \n                               v-model=\"username\" @input=\"handleUsernameInput\" />\n                    </view>\n                    <view class=\"t-a\">\n                        <text class=\"txt\">密码</text>\n                        <input type=\"password\" name=\"password\" maxlength=\"99\" placeholder=\"请输入您的密码\" \n                               v-model=\"password\" @input=\"handlePasswordInput\" />\n                    </view>\n                    <button @tap=\"login()\">登 录</button>\n                </form>\n            </view>\n        </view>\n    </view>\n</template>\n\n<script>\n// 使用npm安装的JSEncrypt\nimport JSEncrypt from 'jsencrypt';\nimport { request } from '@/components/request.js';\n\nexport default {\n    data() {\n        return {\n            username: '',\n            password: '',\n            isLoading: false\n        };\n    },\n    methods: {\n        handleUsernameInput(e) {\n            const maxLength = 20;\n            if (e.detail.value.length > maxLength) {\n                this.username = e.detail.value.slice(0, maxLength);\n                uni.showToast({ \n                    title: `用户名不能超过${maxLength}位`, \n                    icon: 'none' \n                });\n            }\n        },\n        \n        handlePasswordInput(e) {\n            const maxLength = 32;\n            if (e.detail.value.length > maxLength) {\n                this.password = e.detail.value.slice(0, maxLength);\n                uni.showToast({ \n                    title: `密码不能超过${maxLength}位`, \n                    icon: 'none' \n                });\n            }\n        },\n        \n        async login() {\n            try {\n                if (!this.username) {\n                    uni.showToast({ title: '请输入用户名', icon: 'none' });\n                    return;\n                }\n                if (!this.password) {\n                    uni.showToast({ title: '请输入密码', icon: 'none' });\n                    return;\n                }\n\n                // 1. 获取公钥\n                const publicKeyRes = await request({\n                    url: '/api/v1/auth/publicKey',\n                    method: 'GET'\n                });\n\n                const publicKey = publicKeyRes.data;\n                if (!publicKey) {\n                    throw new Error('获取公钥失败');\n                }\n\n                // 2. 加密密码\n                const encryptor = new JSEncrypt();\n                encryptor.setPublicKey(publicKey);\n                const encryptedPwd = encryptor.encrypt(this.password);\n                if (!encryptedPwd) {\n                    throw new Error('密码加密失败');\n                }\n\n                // 3. 手动构建查询字符串\n                const queryString = `username=${encodeURIComponent(this.username)}&password=${encodeURIComponent(encryptedPwd)}`;\n\n                // 4. 发送登录请求（使用手动构建的查询字符串）\n                const loginRes = await request({\n                    url: `/api/v1/auth/login?${queryString}`,\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/x-www-form-urlencoded'\n                    }\n                });\n\n                // 5. 处理登录结果\n                if (loginRes.code === '00000') {\n                    uni.setStorageSync('token', loginRes.data.accessToken);\n                    uni.setStorageSync('username', this.username);\n\n                    uni.showToast({ title: '登录成功', icon: 'none' });\n                    setTimeout(() => {\n                        uni.reLaunch({ url: '/pages/index/index' });\n                    }, 1000);\n                } else {\n                    throw new Error(loginRes.msg || '登录失败');\n                }\n\n            } catch (error) {\n                console.error('登录出错:', error);\n                uni.showToast({\n                    title: error.message || '登录失败，请重试',\n                    icon: 'none'\n                });\n            }\n        }\n    }\n};\n</script>\n\n<style scoped>\n/* 保持原有的样式不变 */\n.txt {\n    font-size: 32rpx;\n    font-weight: bold;\n    color: #333333;\n}\n.img-a {\n    width: 100%;\n    height: 450rpx;\n    background-color: #2796f2;\n    background-size: 100%;\n}\n\n.login-view {\n    width: 100%;\n    position: relative;\n    margin-top: -120rpx;\n    background-color: #ffffff;\n    border-radius: 8% 8% 0% 0;\n}\n\n.t-login {\n    width: 600rpx;\n    margin: 0 auto;\n    font-size: 28rpx;\n    padding-top: 80rpx;\n}\n\n.t-login button {\n    font-size: 28rpx;\n    background: #2796f2;\n    color: #fff;\n    height: 90rpx;\n    line-height: 90rpx;\n    border-radius: 50rpx;\n    font-weight: bold;\n}\n\n.t-login input {\n    height: 90rpx;\n    line-height: 90rpx;\n    margin-bottom: 50rpx;\n    border-bottom: 1px solid #e9e9e9;\n    font-size: 28rpx;\n}\n\n.t-login .t-a {\n    position: relative;\n}\n\n.t-b {\n    text-align: left;\n    font-size: 42rpx;\n    color: #ffffff;\n    padding: 130rpx 0 0 70rpx;\n    font-weight: bold;\n    line-height: 70rpx;\n}\n\n/* 新增的副标题样式 */\n.sub-title {\n    font-size: 34rpx;\n    color: #ffffff;\n    /* margin-top: 10rpx; */\n    font-weight: normal;\n    opacity: 0.9;\n}\n\n.t-login .t-c {\n    position: absolute;\n    right: 22rpx;\n    top: 22rpx;\n    background: #5677fc;\n    color: #fff;\n    font-size: 24rpx;\n    border-radius: 50rpx;\n    height: 50rpx;\n    line-height: 50rpx;\n    padding: 0 25rpx;\n}\n\n.t-login .t-d {\n    text-align: center;\n    color: #999;\n    margin: 80rpx 0;\n}\n\n.t-login .t-e {\n    text-align: center;\n    width: 250rpx;\n}\n\n.t-login .t-g {\n    float: left;\n    width: 50%;\n}\n\n.t-login .t-e image {\n    width: 50rpx;\n    height: 50rpx;\n}\n\n.t-login .t-f {\n    text-align: center;\n    margin: 150rpx 0 0 0;\n    color: #666;\n}\n\n.t-login .t-f text {\n    margin-left: 20rpx;\n    color: #aaaaaa;\n    font-size: 27rpx;\n}\n\n.t-login .uni-input-placeholder {\n    color: #aeaeae;\n}\n\n.cl {\n    zoom: 1;\n}\n\n.cl:after {\n    clear: both;\n    display: block;\n    visibility: hidden;\n    height: 0;\n    content: '\\20';\n}\n</style>","import MiniProgramPage from 'C:/Users/25855/Desktop/狮山云瞳/狮山云瞳/狮山云瞳/狮山云瞳/pages/login/login.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","request","JSEncrypt"],"mappings":";;;AAmCA,MAAK,YAAU;AAAA,EACX,OAAO;AACH,WAAO;AAAA,MACH,UAAU;AAAA,MACV,UAAU;AAAA,MACV,WAAW;AAAA;EAElB;AAAA,EACD,SAAS;AAAA,IACL,oBAAoB,GAAG;AACnB,YAAM,YAAY;AAClB,UAAI,EAAE,OAAO,MAAM,SAAS,WAAW;AACnC,aAAK,WAAW,EAAE,OAAO,MAAM,MAAM,GAAG,SAAS;AACjDA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO,UAAU,SAAS;AAAA,UAC1B,MAAM;AAAA,QACV,CAAC;AAAA,MACL;AAAA,IACH;AAAA,IAED,oBAAoB,GAAG;AACnB,YAAM,YAAY;AAClB,UAAI,EAAE,OAAO,MAAM,SAAS,WAAW;AACnC,aAAK,WAAW,EAAE,OAAO,MAAM,MAAM,GAAG,SAAS;AACjDA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO,SAAS,SAAS;AAAA,UACzB,MAAM;AAAA,QACV,CAAC;AAAA,MACL;AAAA,IACH;AAAA,IAED,MAAM,QAAQ;AACV,UAAI;AACA,YAAI,CAAC,KAAK,UAAU;AAChBA,wBAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,OAAK,CAAG;AAC/C;AAAA,QACJ;AACA,YAAI,CAAC,KAAK,UAAU;AAChBA,wBAAG,MAAC,UAAU,EAAE,OAAO,SAAS,MAAM,OAAK,CAAG;AAC9C;AAAA,QACJ;AAGA,cAAM,eAAe,MAAMC,2BAAQ;AAAA,UAC/B,KAAK;AAAA,UACL,QAAQ;AAAA,QACZ,CAAC;AAED,cAAM,YAAY,aAAa;AAC/B,YAAI,CAAC,WAAW;AACZ,gBAAM,IAAI,MAAM,QAAQ;AAAA,QAC5B;AAGA,cAAM,YAAY,IAAIC,cAAAA;AACtB,kBAAU,aAAa,SAAS;AAChC,cAAM,eAAe,UAAU,QAAQ,KAAK,QAAQ;AACpD,YAAI,CAAC,cAAc;AACf,gBAAM,IAAI,MAAM,QAAQ;AAAA,QAC5B;AAGA,cAAM,cAAc,YAAY,mBAAmB,KAAK,QAAQ,CAAC,aAAa,mBAAmB,YAAY,CAAC;AAG9G,cAAM,WAAW,MAAMD,2BAAQ;AAAA,UAC3B,KAAK,sBAAsB,WAAW;AAAA,UACtC,QAAQ;AAAA,UACR,SAAS;AAAA,YACL,gBAAgB;AAAA,UACpB;AAAA,QACJ,CAAC;AAGD,YAAI,SAAS,SAAS,SAAS;AAC3BD,wBAAG,MAAC,eAAe,SAAS,SAAS,KAAK,WAAW;AACrDA,wBAAAA,MAAI,eAAe,YAAY,KAAK,QAAQ;AAE5CA,wBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,OAAK,CAAG;AAC7C,qBAAW,MAAM;AACbA,0BAAAA,MAAI,SAAS,EAAE,KAAK,qBAAsB,CAAA;AAAA,UAC7C,GAAE,GAAI;AAAA,eACJ;AACH,gBAAM,IAAI,MAAM,SAAS,OAAO,MAAM;AAAA,QAC1C;AAAA,MAEF,SAAO,OAAO;AACZA,sBAAc,MAAA,MAAA,SAAA,gCAAA,SAAS,KAAK;AAC5BA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO,MAAM,WAAW;AAAA,UACxB,MAAM;AAAA,QACV,CAAC;AAAA,MACL;AAAA,IACJ;AAAA,EACJ;AACJ;;;;;;;;;;;ACjIA,GAAG,WAAW,eAAe;"}